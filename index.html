<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cell Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { color: #333; }
    textarea, input { width: 100%; margin: 5px 0; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { margin: 5px 3px; padding: 8px 12px; border: none; border-radius: 4px; background: #4CAF50; color: white; cursor: pointer; }
    button:hover { background: #45a049; }
    .result { background: white; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; }
    .map-btn { background: #2196F3; }
    .delete-btn { background: #f44336; }
    .export-btn { background: #9c27b0; }
  </style>
</head>
<body>
  <h1>Cell Tracker</h1>

  <label>API Key:</label>
  <input type="text" id="apiKeyInput" placeholder="Nhập API Key UnwiredLabs">
  <button onclick="saveApiKey()">Lưu API</button>
  <button class="delete-btn" onclick="deleteApiKey()">Xóa API</button>

  <label>Nhập cell (mỗi cell một dòng, dạng mnc.lac.cellid):</label>
  <textarea id="cellInput" rows="6" placeholder="Ví dụ: 1.12345.67890"></textarea>
  <button onclick="trackCells()">Tra Cell</button>
  <button class="export-btn" onclick="exportToExcel()">Xuất Excel</button>
  <button class="map-btn" onclick="openAllMaps()">Mở tất cả bản đồ</button>

  <div id="results"></div>

  <script>
    const MCC = 452; // MCC Việt Nam
    let results = [];

    // Lưu & xóa API
    function saveApiKey() {
      const key = document.getElementById("apiKeyInput").value;
      if (key) {
        localStorage.setItem("apiKey", key);
        alert("Đã lưu API key!");
      }
    }
    function deleteApiKey() {
      localStorage.removeItem("apiKey");
      alert("Đã xóa API key!");
    }
    window.onload = () => {
      const savedKey = localStorage.getItem("apiKey");
      if (savedKey) document.getElementById("apiKeyInput").value = savedKey;
    };

    // Tra nhiều cell
    async function trackCells() {
      const apiKey = localStorage.getItem("apiKey");
      if (!apiKey) return alert("Hãy nhập và lưu API key!");

      const cells = document.getElementById("cellInput").value.trim().split("\n");
      for (let cell of cells) {
        if (!cell.includes(".")) continue;
        const [mnc, lac, cid] = cell.split(".");
        await fetchCell(apiKey, mnc, lac, cid);
      }
    }

    async function fetchCell(apiKey, mnc, lac, cid) {
      const types = ["umts", "lte", "nbiot", "nr"];
      for (let radio of types) {
        const res = await fetch("https://us1.unwiredlabs.com/v2/process.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            token: apiKey,
            radio: radio,
            mcc: MCC,
            mnc: parseInt(mnc),
            cells: [{ lac: parseInt(lac), cid: parseInt(cid) }],
            address: 1
          })
        });
        const data = await res.json();
        if (data.status === "ok") {
          const record = {
            cell: `${mnc}.${lac}.${cid}`,
            time: new Date().toLocaleString(),
            lat: data.lat, lon: data.lon,
            network: radio.toUpperCase(),
            accuracy: data.accuracy || "N/A",
            address: data.address || "Không rõ"
          };
          results.push(record);
          showResult(record);
          break;
        }
      }
    }

    // Hiển thị kết quả
    function showResult(r) {
      const div = document.createElement("div");
      div.className = "result";
      div.innerHTML = `
        <b>Cell:</b> ${r.cell}<br>
        <b>Thời gian:</b> ${r.time}<br>
        <b>Tọa độ:</b> ${r.lat}, ${r.lon}<br>
        <b>Mạng:</b> ${r.network}<br>
        <b>Khoảng cách:</b> ${r.accuracy} m<br>
        <b>Địa chỉ:</b> ${r.address}<br>
        <button class="map-btn" onclick="openMap(${r.lat},${r.lon})">Mở bản đồ</button>
        <button class="delete-btn" onclick="this.parentElement.remove()">Xóa</button>
      `;
      document.getElementById("results").appendChild(div);
    }

    // Mở bản đồ
    function openMap(lat, lon) {
      window.open(`https://www.google.com/maps?q=${lat},${lon}`, "_blank");
    }
    function openAllMaps() {
      results.forEach(r => {
        window.open(`https://www.google.com/maps?q=${r.lat},${r.lon}`, "_blank");
      });
    }

    // Xuất Excel XML
    function exportToExcel() {
      if (results.length === 0) return alert("Chưa có dữ liệu!");
      let xml = `<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>
      <Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
      xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:x="urn:schemas-microsoft-com:office:excel"
      xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
      <Worksheet ss:Name="Cells"><Table>
      <Row><Cell><Data ss:Type="String">Cell</Data></Cell>
      <Cell><Data ss:Type="String">Thời gian</Data></Cell>
      <Cell><Data ss:Type="String">Lat</Data></Cell>
      <Cell><Data ss:Type="String">Lon</Data></Cell>
      <Cell><Data ss:Type="String">Mạng</Data></Cell>
      <Cell><Data ss:Type="String">Khoảng cách</Data></Cell>
      <Cell><Data ss:Type="String">Địa chỉ</Data></Cell></Row>`;
      results.forEach(r => {
        xml += `<Row>
          <Cell><Data ss:Type="String">${r.cell}</Data></Cell>
          <Cell><Data ss:Type="String">${r.time}</Data></Cell>
          <Cell><Data ss:Type="Number">${r.lat}</Data></Cell>
          <Cell><Data ss:Type="Number">${r.lon}</Data></Cell>
          <Cell><Data ss:Type="String">${r.network}</Data></Cell>
          <Cell><Data ss:Type="String">${r.accuracy}</Data></Cell>
          <Cell><Data ss:Type="String">${r.address}</Data></Cell>
        </Row>`;
      });
      xml += `</Table></Worksheet></Workbook>`;
      const blob = new Blob([xml], { type: "application/vnd.ms-excel" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cell_tracker.xml";
      a.click();
    }
  </script>
</body>
</html>
